context("explain WHO English codes")

test_that("some codes not in ICD-10-CM", {
  # For testing when icd.data may be wrong version:
  skip_missing_icd10who()
  for (hiv in c(
    "B20", "B21", "B22", "B23", "B24",
    "B21.9", "B22.7", "B238", "Z21"
  )) {
    expect_match(x <- explain_code(as.icd10who(hiv)),
      "HIV",
      info = paste("HIV code: ", hiv)
    )
    expect_identical(x, explain_code(as.icd10who(hiv)))
    expect_length(x, 1)
  }
})

test_that("hand-picked WHO-only codes okay", {
  skip_missing_icd10who()
  expect_identical(
    explain_code(as.icd10who("U842")),
    "Resistance to antiviral drug(s)"
  )
})

context("explain WHO French codes")

test_that("some codes not in ICD-10-CM", {
  # For testing when icd.data may be wrong version:
  skip_missing_icd10who()
  # https://icd.who.int/browse10/2008/fr#/Z21
  # https://icd.who.int/browse10/2008/fr#/B21.9 (.0 .1 .2 .3 .7 .8 .9)
  for (hiv in c(
    "B20", "B21", "B22", "B23", "B24",
    "B21.9", "B22.7", "B238", "Z21"
  )) {
    expect_error(
      regexp = NA,
      length(x <- explain_code(as.icd10who(hiv), lang = "fr")) > 0,
      info = paste("VIH (HIV) code: ", hiv)
    )
    # workaround https://github.com/r-lib/testthat/issues/867
    expect_true(length(x) &&
      all(grepl("VIH", x)),
    info = paste("VIH (HIV) code: ", hiv)
    )
    # expect_match(x,
    #   regexp = "VIH",
    #   info = paste("VIH (HIV) code: ", hiv)
    # )
    expect_length(x, 1)
  }
})

test_that("hand-picked WHO-only codes okay", {
  skip_missing_icd10who()
  expect_identical(
    explain_code(as.icd10who("F21"), lang = "fr"),
    "Trouble schizotypique"
  )
})
